# cfs_postproc — Creality CFS flush-matrix scaler + safe pre-cut inserts

**High-Level Summary:**
This post processor script and the optimized `box.cfg` work together to significantly reduce tool change filament waste by:
- **Changing default behavior**: Optimizing the CFS box configuration to eliminate unnecessary repeated movements
- **Pre-cut retract**: Adding a safe pre-cut retraction sequence to reduce post-cut ooze and improve reliability
- **Reducing variable color pair purge volumes**: Applying the flush multiplier to color-dependent purge volumes that the firmware ignores

**What it does**
- Reads the Creality Print comments:
  - `; flush_multiplier = <float>`
  - `; flush_volumes_matrix = <16 integers>` (row-major, 4×4 for T0..T3 → T0..T3)
- Because the printer firmware **ignores the multiplier**, this tool:
  - **Applies the multiplier** to the 16 matrix values (mm³),
  - **Rounds to integers**, and
  - **Rewrites** the `flush_volumes_matrix` line in the G-code.
- **Safety:** it also rewrites any `; flush_multiplier = ...` in the output to **`1.0`**
  to avoid accidental double scaling if firmware ever starts honoring it. The actual
  **applied multiplier** is recorded in the header as `; applied_flush_multiplier: ...`.
- Leaves purge/prime tower and slicer motions **intact** (no removal, no `CFS_PURGE`).
- Still improves reliability by inserting a **pre-cut retract sequence** at each *real* tool transition:
  - Small **depart Z-hop**
  - **Auto-park** at the **wipe/prime tower center** (if detected; or you can override)
  - **Pre-cut retract** to reduce post-cut ooze
- Adds optional **console sentinels** (`M118`) so you can see transitions & pre-cut clearly in Fluidd/Mainsail.

## CFS Firmware and Slicer Integration

The Creality CFS firmware is designed to parse the `; flush_volumes_matrix = ...` comment that is generated by Creality Print slicer. This matrix contains 16 integer values representing the flush volumes (in mm³) for all possible tool-to-tool transitions (4 tools × 4 tools).

**Why Creality Print is the better slicer for color-dependent purge volumes:**
- Creality Print includes a flush volume grid UI that allows you to set different purge volumes for each color transition
- The slicer generates the `; flush_volumes_matrix = ...` comment in the G-code, which the CFS firmware reads and uses
- This enables truly color-dependent purge behavior where different color combinations can have different purge volumes

**The multiplier issue:**
- While Creality Print provides a multiplier setting in the UI, this multiplier is **not honored by the CFS firmware**
- The firmware only reads the raw matrix values and ignores any multiplier comments
- This script fixes this limitation by applying the multiplier to the matrix values before the firmware reads them

**Behavior with other slicers:**
- If another slicer is used (i.e., no flush matrix comment in the G-code), the CFS firmware defaults to a fixed 179mm purge volume for all tool changes
- This means you lose the color-dependent purge behavior and get the same purge volume regardless of color transitions

**Orca Slicer vs Creality Print comparison:**
- **Orca Slicer**: Has a flush volume grid UI, but these settings have **no effect** on the generated G-code - the flush volumes are not written to the output file
- **Creality Print**: Has a flush volume grid UI that **does work** and writes the matrix to the G-code comment
- **Note**: Manual changes to the grid in Creality Print UI may not always be reflected in the resulting G-code due to slicer limitations

**Prime Towers and Purge Behavior:**
- **Tool change variable flushing/purging** is controlled by the **CFS box firmware**, not the slicer
- **Prime towers** can be used to improve print quality by ensuring proper nozzle priming, but this is **in addition to** the firmware-controlled purge
- **Tower purges are invariable** - they flush the specified volume to the tower regardless of which tool change is occurring
- **When using prime towers**, the grid multiplier can be **reduced** since the tower handles some of the purging, reducing overall filament waste

## Files
- `src/cfs_postproc/cfs_postproc.py` – main post-processor script
- `src/cfs_postproc/cfs_postproc_rightclick.py` – simple right-click/CLI wrapper for batch processing
- `src/cfs_postproc/__init__.py` – package initialization
- `src/cfs_postproc/__main__.py` – enables running as module: `python -m cfs_postproc`
- `samples/` – sample G-code files and configuration examples

## Installation Instructions
To install the cfs_postproc script, follow these steps:
1. Ensure you have Python 3.8 or later installed on your system.
2. Clone the repository using `git clone https://github.com/ehsmaes/cfs-postproc.git`
3. Navigate to the cloned repository using `cd cfs-postproc`
4. Install the required dependencies using `pip install -r requirements.txt`
5. Make the script executable using `chmod +x src/cfs_postproc/cfs_postproc.py`
6. Place the script in a convenient location, such as `~/Documents/scripts/`
7. Note: cfs_postproc_rightclick.py is recommended to be installed as a file manager context menu, but the exact steps for this vary depending on your operating system.
8. Install the `samples/k1.box.new.cfg` file as `box.cfg` on your K1 printer. Review and tweak the values before use, and save the original `box.cfg` file so you can roll back if needed.

## Usage
The idea was to run the post processor from within the slicer but I never figured out how to get it running. If you figure it out, let me know! Until then, slice the file, export the GCODE, post process, then upload to your printer.
Slicer settings (Creality Print):
- Modify the Flush volume multiplier (small faucet at the top of the filament panel). A good start is 0.6. Ignore the warnings.
- Enable Prime tower. Try Width 20 and Prime volume 30 or 50.
### A) Command line (single file)
```bash
python3 ~/Documents/scripts/cfs_postproc.py input.gcode output_scaled_precut.gcode \
  --m118-sentinels --console-summary
```

### B) Command line (right-click wrapper)
```bash
python3 ~/Documents/scripts/cfs_postproc_rightclick.py /path/to/file.gcode
# or multiple
python3 ~/Documents/scripts/cfs_postproc_rightclick.py *.gcode
```
The wrapper writes `*_scaled_precut.gcode` next to the source.

## CLI options (main script)
```
cfs_postproc.py input.gcode output.gcode [options]

--precut-mm <float>      Pre-cut retract length in mm (default: 80.0)
--precut-f <int>         Pre-cut retract feedrate (default: 600)
--zhop-mm <float>        Small depart Z-hop before moving to park (default: 0.6)
--zhop-f <int>           Z-hop feedrate (default: 3000)
--travel-f <int>         XY travel feedrate to park (default: 18000)
--precut-park-xy "X,Y"   Override park position (default: auto-detect tower center)
--m118-sentinels         Print console markers around transitions & pre-cuts (M118)
--console-summary        Print the header report to the console
```

## Header example
```
; Post-processed by cfs_postproc on 2025-10-01T12:34:56
; applied_flush_multiplier: 0.250000
; original flush_volumes_matrix (mm^3):
;      0,  106,  114,   70
;    124,    0,  113,   81
;    195,  184,    0,   72
;    190,  214,  151,    0
; scaled flush_volumes_matrix (mm^3) written:
;      0,   27,   29,   18
;     31,    0,   28,   20
;     49,   46,    0,   18
;     48,   54,   38,    0
; pre-cut: 80.0mm @ F600
; park XY: X159.500 Y39.750 (tower-center autodetect)
; (Any `; flush_multiplier = ...` lines in the output are forced to `1.0` as a guard)
```

## About k1.box.cfg

The `k1.box.cfg` file is a custom configuration file used by Creality CFS (Creality Filament System) to control the behavior of the CFS box. This file contains various parameters that govern filament cutting, retraction, extrusion, and cleaning operations.

### Key Parameters and Behaviors

**Important Notes:**
- **Not all parameters are used or behave as expected** in the current firmware
- **Pre-cut retraction (`Tn_retrude`)** appears to be non-functional in current firmware versions
- **Undocumented default tool-change purge**: There is an undocumented default purge of 179mm that occurs during tool changes
- **Poop-shoot repetition issue**: If `Tn_extrude` and `box_*_length` parameters sum to less than 180mm, the system will perform repeated poop-shoot movements to purge the required 180mm

**Recommended Configuration:**
The values have been optimized from the original 140+140=280mm to 90+90=180mm to avoid repeated movements while still meeting the undocumented purge requirement.

### Configuration Sections

**Cutting and Positioning:**
- `pre_cut_pos_x`, `pre_cut_pos_y`: Pre-cut positions
- `cut_pos_x`, `cut_pos_y`: Actual cut positions
- `cut_velocity`: High-speed cut motion

**Retraction and Extrusion:**
- `Tn_retrude`: Supposed backward pull before cut (currently non-functional)
- `Tn_extrude`: Single purge blob extrusion length
- `Tn_extrude_velocity`: Extrude speed

**Nozzle Cleaning:**
- `box_first_clean_length`: Initial clean length for first color change
- `box_need_clean_length`: Regular clean length for subsequent tool changes
- `box_need_clean_length_max`: Maximum clean length

**Nozzle Positions:**
- `extrude_pos_x`, `extrude_pos_y`, `extrude_pos_z`: Extrusion positions
- `clean_left_pos_x`, `clean_left_pos_y`: Left wipe position (PTFE pad)
- `clean_right_pos_x`, `clean_right_pos_y`: Right wipe position

### Sample Files
- `samples/k1.box.new.cfg`: Optimized configuration with improved values and documentation

**Recent Updates:**
- Configuration files renamed from `box.org.cfg` and `box.new.cfg` to `k1.box.org.cfg` and `k1.box.new.cfg` to clarify they are specific to Creality K1 printers
- Enhanced documentation in the configuration files showing original values and detailed explanations
- Optimized parameters to reduce filament waste while maintaining reliable operation

**Testing Configuration:**
The configuration and scripts were tested on a Creality K1 with Microswiss nozzle and one CFS box. Some configurations may need to be tuned for other printer models, nozzle types, or multiple CFS box setups.
