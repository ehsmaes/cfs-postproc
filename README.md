# cfs_postproc — Creality CFS flush-matrix scaler + safe pre-cut inserts

**What it does**
- Reads the Creality Print comments:
  - `; flush_multiplier = <float>`
  - `; flush_volumes_matrix = <16 integers>` (row-major, 4×4 for T0..T3 → T0..T3)
- Because the printer firmware **ignores the multiplier**, this tool:
  - **Applies the multiplier** to the 16 matrix values (mm³),
  - **Rounds to integers**, and
  - **Rewrites** the `flush_volumes_matrix` line in the G-code.
- **Safety:** it also rewrites any `; flush_multiplier = ...` in the output to **`1.0`**
  to avoid accidental double scaling if firmware ever starts honoring it. The actual
  **applied multiplier** is recorded in the header as `; applied_flush_multiplier: ...`.
- Leaves purge/prime tower and slicer motions **intact** (no removal, no `CFS_PURGE`).
- Still improves reliability by inserting a **pre-cut retract sequence** at each *real* tool transition:
  - Small **depart Z-hop**
  - **Auto-park** at the **wipe/prime tower center** (if detected; or you can override)
  - **Pre-cut retract** to reduce post-cut ooze
- Adds optional **console sentinels** (`M118`) so you can see transitions & pre-cut clearly in Fluidd/Mainsail.

## CFS Firmware and Slicer Integration

The Creality CFS firmware is designed to parse the `; flush_volumes_matrix = ...` comment that is generated by Creality Print slicer. This matrix contains 16 integer values representing the flush volumes (in mm³) for all possible tool-to-tool transitions (4 tools × 4 tools).

**Why Creality Print is the better slicer for color-dependent purge volumes:**
- Creality Print includes a flush volume grid UI that allows you to set different purge volumes for each color transition
- The slicer generates the `; flush_volumes_matrix = ...` comment in the G-code, which the CFS firmware reads and uses
- This enables truly color-dependent purge behavior where different color combinations can have different purge volumes

**The multiplier issue:**
- While Creality Print provides a multiplier setting in the UI, this multiplier is **not honored by the CFS firmware**
- The firmware only reads the raw matrix values and ignores any multiplier comments
- This script fixes this limitation by applying the multiplier to the matrix values before the firmware reads them

**Behavior with other slicers:**
- If another slicer is used (i.e., no flush matrix comment in the G-code), the CFS firmware defaults to a fixed 179mm purge volume for all tool changes
- This means you lose the color-dependent purge behavior and get the same purge volume regardless of color transitions

**Orca Slicer vs Creality Print comparison:**
- **Orca Slicer**: Has a flush volume grid UI, but these settings have **no effect** on the generated G-code - the flush volumes are not written to the output file
- **Creality Print**: Has a flush volume grid UI that **does work** and writes the matrix to the G-code comment
- **Note**: Manual changes to the grid in Creality Print UI may not always be reflected in the resulting G-code due to slicer limitations

## Files
- `src/cfs_postproc/cfs_postproc.py` – main post-processor script
- `src/cfs_postproc/cfs_postproc_rightclick.py` – simple right-click/CLI wrapper for batch processing
- `src/cfs_postproc/__init__.py` – package initialization
- `src/cfs_postproc/__main__.py` – enables running as module: `python -m cfs_postproc`
- `pyproject.toml` – Python package configuration and dependencies
- `Makefile` – build and development commands
- `tests/` – unit and integration tests
- `samples/` – sample G-code files and configuration examples

## Install
Place both files somewhere convenient, e.g. `~/Documents/scripts/` and make them executable:
```bash
chmod +x ~/Documents/scripts/cfs_postproc.py
chmod +x ~/Documents/scripts/cfs_postproc_rightclick.py
```

## Usage
### A) Command line (single file)
```bash
python3 ~/Documents/scripts/cfs_postproc.py input.gcode output_scaled_precut.gcode \
  --m118-sentinels --console-summary
```

### B) Command line (right-click wrapper)
```bash
python3 ~/Documents/scripts/cfs_postproc_rightclick.py /path/to/file.gcode
# or multiple
python3 ~/Documents/scripts/cfs_postproc_rightclick.py *.gcode
```
The wrapper writes `*_scaled_precut.gcode` next to the source.

## CLI options (main script)
```
cfs_postproc.py input.gcode output.gcode [options]

--precut-mm <float>      Pre-cut retract length in mm (default: 80.0)
--precut-f <int>         Pre-cut retract feedrate (default: 600)
--zhop-mm <float>        Small depart Z-hop before moving to park (default: 0.6)
--zhop-f <int>           Z-hop feedrate (default: 3000)
--travel-f <int>         XY travel feedrate to park (default: 18000)
--precut-park-xy "X,Y"   Override park position (default: auto-detect tower center)
--m118-sentinels         Print console markers around transitions & pre-cuts (M118)
--console-summary        Print the header report to the console
```

## Header example
```
; Post-processed by cfs_postproc on 2025-10-01T12:34:56
; applied_flush_multiplier: 0.250000
; original flush_volumes_matrix (mm^3):
;      0,  106,  114,   70
;    124,    0,  113,   81
;    195,  184,    0,   72
;    190,  214,  151,    0
; scaled flush_volumes_matrix (mm^3) written:
;      0,   27,   29,   18
;     31,    0,   28,   20
;     49,   46,    0,   18
;     48,   54,   38,    0
; pre-cut: 80.0mm @ F600
; park XY: X159.500 Y39.750 (tower-center autodetect)
; (Any `; flush_multiplier = ...` lines in the output are forced to `1.0` as a guard)
```

## About box.cfg

The `box.cfg` file is a custom configuration file used by Creality CFS (Creality Filament System) to control the behavior of the CFS box. This file contains various parameters that govern filament cutting, retraction, extrusion, and cleaning operations.

### Key Parameters and Behaviors

**Important Notes:**
- **Not all parameters are used or behave as expected** in the current firmware
- **Pre-cut retraction (`Tn_retrude`)** appears to be non-functional in current firmware versions
- **Undocumented default tool-change purge**: There is an undocumented default purge of 179mm that occurs during tool changes
- **Poop-shoot repetition issue**: If `Tn_extrude` and `box_*_length` parameters sum to less than 180mm, the system will perform repeated poop-shoot movements to purge the required 180mm

**Recommended Configuration:**
The values have been optimized from the original 140+140=280mm to 90+90=180mm to avoid repeated movements while still meeting the undocumented purge requirement.

### Configuration Sections

**Cutting and Positioning:**
- `pre_cut_pos_x`, `pre_cut_pos_y`: Pre-cut positions
- `cut_pos_x`, `cut_pos_y`: Actual cut positions
- `cut_velocity`: High-speed cut motion

**Retraction and Extrusion:**
- `Tn_retrude`: Supposed backward pull before cut (currently non-functional)
- `Tn_extrude`: Single purge blob extrusion length
- `Tn_extrude_velocity`: Extrude speed

**Nozzle Cleaning:**
- `box_first_clean_length`: Initial clean length for first color change
- `box_need_clean_length`: Regular clean length for subsequent tool changes
- `box_need_clean_length_max`: Maximum clean length

**Nozzle Positions:**
- `extrude_pos_x`, `extrude_pos_y`, `extrude_pos_z`: Extrusion positions
- `clean_left_pos_x`, `clean_left_pos_y`: Left wipe position (PTFE pad)
- `clean_right_pos_x`, `clean_right_pos_y`: Right wipe position

### Sample Files
- `samples/box.org.cfg`: Original configuration file
- `samples/box.new.cfg`: Optimized configuration with improved values and documentation
