[serial_485 serial485]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
baud: 230400

[auto_addr]

[box]
bus:serial485                          # Required: communication with the CFS box
filament_sensor:filament_sensor_2     # Active filament sensor channel

# --- Cutting and positioning ---
pre_cut_pos_x:42.0#223.8
pre_cut_pos_y:160.0#200
cut_pos_x:42.0#223.8
cut_pos_y:223.3#225
cut_pos_offset:1.3
cut_find_start_offset_y: 6
cut_velocity:8000

# --- Retraction and extrusion before/after cut ---
Tn_retrude:-60#-1.00#-60
Tn_retrude_velocity:3600#360
Tn_extrude_temp: 220  # Extrusion temperature
Tn_extrude: 140    # If current temperature set temperature, preheat knife 120
Tn_extrude_velocity: 360  # Extrusion speed
buffer_empty_len: 30  # Buffer retraction reserve length, need to extrude the buffer reserve length (the length from cutting the extruder internal collision knife to the extrusion gear)

# --- Optional nozzle pre-cleaning phase ---
box_first_clean_length:140
box_need_clean_length:140
box_need_clean_length_max:140
clean_velocity: 3600

# --- Internal retry and flow parameters ---
box_extrude_retry_num: 5
tn_line_len:40.00

# --- Nozzle wipe and extrude positions ---
has_extrude_pos: 1          # Whether there is a need for extrusion, distinguish K1_MAX and f008
extrude_pos_x:148#150.0#148.0
extrude_pos_y:225.3#200.00
extrude_pos_z:30.0
clean_left_pos_x:153.5  # Left position of PTFE nozzle wipe
clean_left_pos_y:225.3#222.5
clean_right_pos_x:178.0  # Right position of PTFE nozzle wipe
clean_right_pos_y:225.3#222.5
safe_pos_y: 215#226

cut_run_count:1
switch_pin:nozzle_mcu:PA8
version: 1
#cr_machine: 1 # default: 0: F008 / 1: K1SE
retrude_position_x: 42
retrude_position_y: 100

[gcode_macro BOX_CHECK_MATERIAL]
gcode:
  WAIT_EXTRUSION_ALL_MATERIALS

[gcode_macro BOX_LOAD_MATERIAL_WITH_MATERIAL]
gcode:
  M104
  IF_NEED_HOME
  BOX_ERROR_CLEAR
  BOX_CHECK_MATERIAL
  BOX_CUT_MATERIAL
  BOX_RETRUDE_MATERIAL
  BOX_GO_TO_EXTRUDE_POS
  BOX_NOZZLE_CLEAN
  BOX_EXTRUDE_MATERIAL
  BOX_EXTRUDER_EXTRUDE
  BOX_MATERIAL_FLUSH
  RESTORE_POSITION

[gcode_macro BOX_LOAD_MATERIAL_WITHOUT_MATERIAL]
gcode:
  M104
  BOX_CHECK_MATERIAL
  BOX_EXTRUDE_MATERIAL
  BOX_EXTRUDER_EXTRUDE
  BOX_MATERIAL_FLUSH

[gcode_macro BOX_QUIT_MATERIAL]
gcode:
  BOX_ERROR_CLEAR
  BOX_CHECK_MATERIAL
  BOX_CUT_MATERIAL
  BOX_RETRUDE_MATERIAL
  BOX_GO_TO_BOX_EXTRUDE_POS
  ;BOX_RETRUDE_MATERIAL_WITH_TNN
  ;BOX_MOVE_TO_SAFE_POS

# eg:
# BOX_EXTRUDE_MATERIAL TNN=T1A
# BOX_EXTRUDER_EXTRUDE TNN=T1A
# BOX_MATERIAL_FLUSH LEN=100 VELOCITY=360 TEMP=220
# BOX_RETRUDE_MATERIAL_WITH_TNN TNN=T1A

[gcode_macro BOX_INFO_REFRESH]
gcode:
  BOX_SET_PRE_LOADING ADDR={params.ADDR} NUM={params.NUM} ACTION=RUN
  M400
  BOX_GET_RFID ADDR={params.ADDR} NUM={params.NUM}
  M400
  BOX_GET_REMAIN_LEN ADDR={params.ADDR} NUM={params.NUM}
  M400
